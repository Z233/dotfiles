#!/bin/bash
{{- /* Only run on macOS */ -}}
{{- if eq .chezmoi.os "darwin" }}

set -euo pipefail

PLIST_NAME="com.example.kanata.plist"
PLIST_PATH="/Library/LaunchDaemons/${PLIST_NAME}"
DAEMON_LABEL="com.example.kanata"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "ðŸ”§ Setting up Kanata LaunchDaemon..."

# Check if kanata is installed
if ! command -v kanata &> /dev/null; then
    echo -e "${RED}âœ— Error: kanata is not installed${NC}"
    echo "  Install it with: brew install kanata"
    exit 1
fi

# Check if config file exists
KANATA_CONFIG="{{ .chezmoi.homeDir }}/.config/kanata/fronz.kbd"
if [[ ! -f "${KANATA_CONFIG}" ]]; then
    echo -e "${YELLOW}âš  Warning: Kanata config not found at ${KANATA_CONFIG}${NC}"
fi

# Render the plist template to a temporary file
TEMP_PLIST=$(mktemp)
trap "rm -f ${TEMP_PLIST}" EXIT

cat > "${TEMP_PLIST}" << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
  "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0"><dict>
  <key>Label</key><string>com.example.kanata</string>
  <key>ProgramArguments</key><array>
{{- if eq .chezmoi.arch "arm64" }}
    <string>/opt/homebrew/bin/kanata</string>
{{- else }}
    <string>/usr/local/bin/kanata</string>
{{- end }}
    <string>-c</string><string>{{ .chezmoi.homeDir }}/.config/kanata/fronz.kbd</string>
    <string>--port</string><string>9999</string>
  </array>
  <key>RunAtLoad</key><true/>
  <key>KeepAlive</key><true/>
  <key>StandardErrorPath</key>
  <string>/var/log/kanata.err</string>
</dict></plist>
EOF

# Check if plist needs updating (no sudo required - plist files are world-readable)
if [[ -f "${PLIST_PATH}" ]] && diff -q "${TEMP_PLIST}" "${PLIST_PATH}" &> /dev/null; then
    echo -e "${GREEN}âœ“ LaunchDaemon plist is already up-to-date${NC}"
    exit 0
fi

# Plist needs to be created or updated
if [[ ! -f "${PLIST_PATH}" ]]; then
    echo "  LaunchDaemon plist not found, will create it"
else
    echo "  LaunchDaemon plist has changed, will update it"
fi

echo "  Requesting sudo access to install LaunchDaemon..."

# Check if daemon is currently loaded
if sudo launchctl print system/"${DAEMON_LABEL}" &> /dev/null; then
    echo "  Unloading existing daemon..."
    sudo launchctl bootout system/"${DAEMON_LABEL}" 2>/dev/null || true
fi

# Copy the plist with sudo
sudo cp "${TEMP_PLIST}" "${PLIST_PATH}"
sudo chown root:wheel "${PLIST_PATH}"
sudo chmod 644 "${PLIST_PATH}"

# Load the daemon
echo "  Loading Kanata LaunchDaemon..."
if sudo launchctl bootstrap system "${PLIST_PATH}"; then
    echo -e "${GREEN}âœ“ Kanata LaunchDaemon installed and loaded successfully${NC}"
else
    echo -e "${RED}âœ— Failed to load LaunchDaemon${NC}"
    echo "  Check logs: sudo tail -f /var/log/kanata.err"
    exit 1
fi

# Verify the daemon is running
sleep 1
if sudo launchctl print system/"${DAEMON_LABEL}" &> /dev/null; then
    echo -e "${GREEN}âœ“ Kanata is running${NC}"
else
    echo -e "${YELLOW}âš  Daemon may not be running. Check: sudo launchctl list | grep kanata${NC}"
fi

{{- end }}
